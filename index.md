libcommunism is intended to be a really, really fast, portable, and small implementation of cooperative multithreading in userspace. It provides a common C++ interface to clients, similar to the C++ `std::thread` class. The caller decides when threads are executed by explicitly switching to them function call style.

Like kernel threads, each cooperative thread (cothread) has its own stack. By performing the context switching in user space (i.e. making it explicit by calling the thread's `switchTo()` method) the significant cost of a switch into the kernel, and the associated kernel processing time is completely removed.

It is freely available under the terms of the [ISC license.](https://choosealicense.com/licenses/isc/)

# Supported Platforms
Currently, the following platforms are supported:

- amd64 (System V ABI)
- amd64 (Windows ABI)

Adding support for other platforms is relatively easy; only a thin platform shim needs to be developed, with a few small assembly routines to switch thread context. Feel free to submit pull requests to add new platforms.

## Requirements
There are no external requirements for using the library besides a functioning C++ compiler. The library itself requires C++20 (due to use of `std::span<T>`) and CMake to build.

# Tests
Tests are provided with the library. They use the [Catch2](https://github.com/catchorg/Catch2) framework, and are built by the `tests` target. Do note that these tests only cover the host's architecture.

## Benchmarks
One of the tests attempts to benchmark the context switching time. Approximate context switching times are:

- amd64 System V: 15ns
- amd64 Windows: 19ns

# Documentation
![Generate Docs](https://github.com/tristanseifert/libcommunism/actions/workflows/docs_doxygen.yml/badge.svg)

For documentation on how to use the library, and how its internals are constructed, please see the [autogenerated Doxygen documentation pages.](/docs/doxygen/index.html) These always reflect the current state of the `main` branch.

## Examples
Proper examples will be provided soon. For now, take a look at the following snippet:

``` cpp
#include <libcommunism/Cothread.h>

static libcommunism::Cothread *thread1, *thread2;

thread1 = new libcommunism::Cothread([](void *) {
    do {
        puts("Hello from cothread 1!");
        thread2->switchTo();
    } while(1);
});
thread2 = new libcommunism::Cothread([](void *) {
    do {
        puts("Hello from cothread 2!");
        thread1->switchTo();
    } while(1);
});

thread1->switchTo();
```

The above code will have two cooperative threads passing control back and forth forever, printing alternating lines of "Hello from cothread 1/2."

