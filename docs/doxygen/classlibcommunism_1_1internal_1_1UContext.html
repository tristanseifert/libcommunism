<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcommunism: libcommunism::internal::UContext Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libcommunism
   </div>
   <div id="projectbrief">Userspace cooperative threading library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacelibcommunism.html">libcommunism</a></li><li class="navelem"><a class="el" href="namespacelibcommunism_1_1internal.html">internal</a></li><li class="navelem"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html">UContext</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-attribs">Static Public Attributes</a> &#124;
<a href="#friends">Friends</a> &#124;
<a href="classlibcommunism_1_1internal_1_1UContext-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">libcommunism::internal::UContext Class Reference<span class="mlabels"><span class="mlabel">final</span></span></div>  </div>
</div><!--header-->
<div class="contents">

<p>Implementation of context switching that uses the C library's <code>setcontext()</code> methods.  
 <a href="classlibcommunism_1_1internal_1_1UContext.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="UContext_8h_source.html">UContext.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for libcommunism::internal::UContext:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classlibcommunism_1_1internal_1_1UContext.png" usemap="#libcommunism::internal::UContext_map" alt=""/>
  <map id="libcommunism::internal::UContext_map" name="libcommunism::internal::UContext_map">
<area href="structlibcommunism_1_1CothreadImpl.html" title="Abstract interface for a platform implementation of cothreads." alt="libcommunism::CothreadImpl" shape="rect" coords="0,0,193,24"/>
  </map>
</div></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a2038ed8e1653b948f8513f5dd90916e2"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#a2038ed8e1653b948f8513f5dd90916e2">UContext</a> (const <a class="el" href="structlibcommunism_1_1CothreadImpl.html#a5dbedbabaaf7c6ee9968f7ee4ec30f85">Entry</a> &amp;entry, const size_t stackSize=0)</td></tr>
<tr class="separator:a2038ed8e1653b948f8513f5dd90916e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2cee92d15d85edc7f8dcd7126e0c0505"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#a2cee92d15d85edc7f8dcd7126e0c0505">UContext</a> (const <a class="el" href="structlibcommunism_1_1CothreadImpl.html#a5dbedbabaaf7c6ee9968f7ee4ec30f85">Entry</a> &amp;entry, std::span&lt; uintptr_t &gt; <a class="el" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>)</td></tr>
<tr class="separator:a2cee92d15d85edc7f8dcd7126e0c0505"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af5c528e58e21c040e464493ff7e45d2f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#af5c528e58e21c040e464493ff7e45d2f">UContext</a> (std::span&lt; uintptr_t &gt; <a class="el" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>)</td></tr>
<tr class="separator:af5c528e58e21c040e464493ff7e45d2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9a0b99abcaf29d50c81932816263b0cb"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#a9a0b99abcaf29d50c81932816263b0cb">~UContext</a> ()</td></tr>
<tr class="separator:a9a0b99abcaf29d50c81932816263b0cb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac77c7640686437e42884919732ca58d1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#ac77c7640686437e42884919732ca58d1">switchTo</a> (<a class="el" href="structlibcommunism_1_1CothreadImpl.html">CothreadImpl</a> *from) override</td></tr>
<tr class="separator:ac77c7640686437e42884919732ca58d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_methods_structlibcommunism_1_1CothreadImpl"><td colspan="2" onclick="javascript:toggleInherit('pub_methods_structlibcommunism_1_1CothreadImpl')"><img src="closed.png" alt="-"/>&#160;Public Member Functions inherited from <a class="el" href="structlibcommunism_1_1CothreadImpl.html">libcommunism::CothreadImpl</a></td></tr>
<tr class="memitem:a061a94af18af48c50388163ea2e67553 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#a061a94af18af48c50388163ea2e67553">CothreadImpl</a> (const <a class="el" href="classlibcommunism_1_1Cothread.html#a56facf24195f6223f0fc1397a9a71467">Cothread::Entry</a> &amp;entry, const size_t stackSize=0)</td></tr>
<tr class="separator:a061a94af18af48c50388163ea2e67553 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a967534ce10932c6f63bb55121df72ad6 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#a967534ce10932c6f63bb55121df72ad6">CothreadImpl</a> (const <a class="el" href="classlibcommunism_1_1Cothread.html#a56facf24195f6223f0fc1397a9a71467">Cothread::Entry</a> &amp;entry, std::span&lt; uintptr_t &gt; <a class="el" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>)</td></tr>
<tr class="separator:a967534ce10932c6f63bb55121df72ad6 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add38899f4f99e845bcfae98779fc1c36 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#add38899f4f99e845bcfae98779fc1c36">CothreadImpl</a> (std::span&lt; uintptr_t &gt; <a class="el" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>)</td></tr>
<tr class="separator:add38899f4f99e845bcfae98779fc1c36 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7b8036a6a294f71d29f2b3ae8148c805 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#a7b8036a6a294f71d29f2b3ae8148c805">~CothreadImpl</a> ()=default</td></tr>
<tr class="separator:a7b8036a6a294f71d29f2b3ae8148c805 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad4b4378c0249a26ddd220a2563159eee inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">virtual size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#ad4b4378c0249a26ddd220a2563159eee">getStackSize</a> () const</td></tr>
<tr class="separator:ad4b4378c0249a26ddd220a2563159eee inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4ee17c3337f46aa1bf4866787ec96919 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">virtual void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#a4ee17c3337f46aa1bf4866787ec96919">getStack</a> () const</td></tr>
<tr class="separator:a4ee17c3337f46aa1bf4866787ec96919 inherit pub_methods_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-attribs"></a>
Static Public Attributes</h2></td></tr>
<tr class="memitem:a5b5fb08c7e8b373ea1504ff4af4a1c53"><td class="memItemLeft" align="right" valign="top">static constexpr const size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">kStackAlignment</a> {64}</td></tr>
<tr class="separator:a5b5fb08c7e8b373ea1504ff4af4a1c53"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:affcb29eed86604c5fcbbf229af2d54c9"><td class="memItemLeft" align="right" valign="top">static constexpr const size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#affcb29eed86604c5fcbbf229af2d54c9">kMainStackSize</a> {128}</td></tr>
<tr class="separator:affcb29eed86604c5fcbbf229af2d54c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe3bd6961f54c575400fdad9fd858f16"><td class="memItemLeft" align="right" valign="top">static constexpr const size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#afe3bd6961f54c575400fdad9fd858f16">kDefaultStackSize</a> {sizeof(uintptr_t) * 0x10000}</td></tr>
<tr class="separator:afe3bd6961f54c575400fdad9fd858f16"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="friends"></a>
Friends</h2></td></tr>
<tr class="memitem:a67705ee68a94373367dd49b99b3dbf18"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structlibcommunism_1_1CothreadImpl.html">CothreadImpl</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classlibcommunism_1_1internal_1_1UContext.html#a67705ee68a94373367dd49b99b3dbf18">libcommunism::AllocKernelThreadWrapper</a> ()</td></tr>
<tr class="separator:a67705ee68a94373367dd49b99b3dbf18"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="inherited"></a>
Additional Inherited Members</h2></td></tr>
<tr class="inherit_header pub_types_structlibcommunism_1_1CothreadImpl"><td colspan="2" onclick="javascript:toggleInherit('pub_types_structlibcommunism_1_1CothreadImpl')"><img src="closed.png" alt="-"/>&#160;Public Types inherited from <a class="el" href="structlibcommunism_1_1CothreadImpl.html">libcommunism::CothreadImpl</a></td></tr>
<tr class="memitem:a5dbedbabaaf7c6ee9968f7ee4ec30f85 inherit pub_types_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">using&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#a5dbedbabaaf7c6ee9968f7ee4ec30f85">Entry</a> = <a class="el" href="classlibcommunism_1_1Cothread.html#a56facf24195f6223f0fc1397a9a71467">Cothread::Entry</a></td></tr>
<tr class="separator:a5dbedbabaaf7c6ee9968f7ee4ec30f85 inherit pub_types_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pro_attribs_structlibcommunism_1_1CothreadImpl"><td colspan="2" onclick="javascript:toggleInherit('pro_attribs_structlibcommunism_1_1CothreadImpl')"><img src="closed.png" alt="-"/>&#160;Protected Attributes inherited from <a class="el" href="structlibcommunism_1_1CothreadImpl.html">libcommunism::CothreadImpl</a></td></tr>
<tr class="memitem:ab0bba692ebd47d478d4d7432ae738476 inherit pro_attribs_structlibcommunism_1_1CothreadImpl"><td class="memItemLeft" align="right" valign="top">std::span&lt; uintptr_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a></td></tr>
<tr class="memdesc:ab0bba692ebd47d478d4d7432ae738476 inherit pro_attribs_structlibcommunism_1_1CothreadImpl"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stack used by this cothread, if any.  <a href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">More...</a><br /></td></tr>
<tr class="separator:ab0bba692ebd47d478d4d7432ae738476 inherit pro_attribs_structlibcommunism_1_1CothreadImpl"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of context switching that uses the C library's <code>setcontext()</code> methods. </p>
<p>This is intended mostly to be a "test" platform that can be used to verify that the core library works, without relying on assembly other such fun stuff. It's not particularly fast so other platform backends should always be used in preference.</p>
<p>Since we need a place to store the context in addition to the stack, it's stored at the very top of the allocated stack. When allocating the stack internally, this is taken account and some extra space at the top is reserved for it; but this must be kept in mind when using an externally allocated stack, as less (roughly <code>sizeof(ucontext_t)</code> and alignment) space than provided will be actually be available as stack.</p>
<dl class="section note"><dt>Note</dt><dd>Since ucontext has been deprecated since the 2008 revision of POSIX, this may stop working (or not even be supported to begin with) on any given platform in the future. </dd></dl>

<p class="definition">Definition at line <a class="el" href="UContext_8h_source.html#l00033">33</a> of file <a class="el" href="UContext_8h_source.html">UContext.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a2038ed8e1653b948f8513f5dd90916e2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2038ed8e1653b948f8513f5dd90916e2">&#9670;&nbsp;</a></span>UContext() <span class="overload">[1/3]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">UContext::UContext </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structlibcommunism_1_1CothreadImpl.html#a5dbedbabaaf7c6ee9968f7ee4ec30f85">Entry</a> &amp;&#160;</td>
          <td class="paramname"><em>entry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const size_t&#160;</td>
          <td class="paramname"><em>stackSize</em> = <code>0</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Allocates a cothread including a context region of the specified size.</p>
<p>This ensures there's sufficient bonus space allocated to hold the ucontext. </p>

<p class="definition">Definition at line <a class="el" href="UContext_8cpp_source.html#l00037">37</a> of file <a class="el" href="UContext_8cpp_source.html">UContext.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;                                                             : <a class="code" href="structlibcommunism_1_1CothreadImpl.html#a061a94af18af48c50388163ea2e67553">CothreadImpl</a>(entry, stackSize) {</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="keywordtype">void</span> *buf{<span class="keyword">nullptr</span>};</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160; </div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="comment">// round down stack size to ensure it&#39;s aligned before allocating it</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keyword">auto</span> allocSize = stackSize &amp; ~(<a class="code" href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">UContext::kStackAlignment</a> - 1);</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    allocSize = allocSize ? allocSize : <a class="code" href="classlibcommunism_1_1internal_1_1UContext.html#afe3bd6961f54c575400fdad9fd858f16">UContext::kDefaultStackSize</a>;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="comment">// then add space for ucontext</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    allocSize += <span class="keyword">sizeof</span>(ucontext_t);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keywordflow">if</span>(allocSize % <a class="code" href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">kStackAlignment</a>) {</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        allocSize += <a class="code" href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">kStackAlignment</a> - (allocSize % <a class="code" href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">kStackAlignment</a>);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    }</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="comment">// and allocate it</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#ifdef _WIN32</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    buf = _aligned_malloc(allocSize, <a class="code" href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">UContext::kStackAlignment</a>);</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordtype">int</span> err{0};</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    err = posix_memalign(&amp;buf, <a class="code" href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">UContext::kStackAlignment</a>, allocSize);</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keywordflow">if</span>(err) {</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;posix_memalign() failed&quot;</span>);</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    }</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordflow">if</span>(!buf) {</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;failed to allocate stack&quot;</span>);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    }</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160; </div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// create it as if we had provided the memory in the first place</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    this-&gt;<a class="code" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a> = {<span class="keyword">reinterpret_cast&lt;</span>uintptr_t *<span class="keyword">&gt;</span>(buf), allocSize / <span class="keyword">sizeof</span>(uintptr_t)};</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    this-&gt;ownsStack = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160; </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    Prepare(<span class="keyword">this</span>, entry);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;}</div>
<div class="ttc" id="aclasslibcommunism_1_1internal_1_1UContext_html_a5b5fb08c7e8b373ea1504ff4af4a1c53"><div class="ttname"><a href="classlibcommunism_1_1internal_1_1UContext.html#a5b5fb08c7e8b373ea1504ff4af4a1c53">libcommunism::internal::UContext::kStackAlignment</a></div><div class="ttdeci">static constexpr const size_t kStackAlignment</div><div class="ttdef"><b>Definition:</b> <a href="UContext_8h_source.html#l00086">UContext.h:86</a></div></div>
<div class="ttc" id="aclasslibcommunism_1_1internal_1_1UContext_html_afe3bd6961f54c575400fdad9fd858f16"><div class="ttname"><a href="classlibcommunism_1_1internal_1_1UContext.html#afe3bd6961f54c575400fdad9fd858f16">libcommunism::internal::UContext::kDefaultStackSize</a></div><div class="ttdeci">static constexpr const size_t kDefaultStackSize</div><div class="ttdef"><b>Definition:</b> <a href="UContext_8h_source.html#l00100">UContext.h:100</a></div></div>
<div class="ttc" id="astructlibcommunism_1_1CothreadImpl_html_a061a94af18af48c50388163ea2e67553"><div class="ttname"><a href="structlibcommunism_1_1CothreadImpl.html#a061a94af18af48c50388163ea2e67553">libcommunism::CothreadImpl::CothreadImpl</a></div><div class="ttdeci">CothreadImpl(const Cothread::Entry &amp;entry, const size_t stackSize=0)</div><div class="ttdef"><b>Definition:</b> <a href="CothreadImpl_8h_source.html#l00029">CothreadImpl.h:29</a></div></div>
<div class="ttc" id="astructlibcommunism_1_1CothreadImpl_html_ab0bba692ebd47d478d4d7432ae738476"><div class="ttname"><a href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">libcommunism::CothreadImpl::stack</a></div><div class="ttdeci">std::span&lt; uintptr_t &gt; stack</div><div class="ttdoc">Stack used by this cothread, if any.</div><div class="ttdef"><b>Definition:</b> <a href="CothreadImpl_8h_source.html#l00088">CothreadImpl.h:88</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2cee92d15d85edc7f8dcd7126e0c0505"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2cee92d15d85edc7f8dcd7126e0c0505">&#9670;&nbsp;</a></span>UContext() <span class="overload">[2/3]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">UContext::UContext </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structlibcommunism_1_1CothreadImpl.html#a5dbedbabaaf7c6ee9968f7ee4ec30f85">Entry</a> &amp;&#160;</td>
          <td class="paramname"><em>entry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::span&lt; uintptr_t &gt;&#160;</td>
          <td class="paramname"><em>stack</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Allocates a cothread with an existing region of memory to back its stack. </p>

<p class="definition">Definition at line <a class="el" href="UContext_8cpp_source.html#l00074">74</a> of file <a class="el" href="UContext_8cpp_source.html">UContext.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                                                               : <a class="code" href="structlibcommunism_1_1CothreadImpl.html#a061a94af18af48c50388163ea2e67553">CothreadImpl</a>(entry, <a class="code" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>) {</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    Prepare(<span class="keyword">this</span>, entry);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af5c528e58e21c040e464493ff7e45d2f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af5c528e58e21c040e464493ff7e45d2f">&#9670;&nbsp;</a></span>UContext() <span class="overload">[3/3]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">libcommunism::internal::UContext::UContext </td>
          <td>(</td>
          <td class="paramtype">std::span&lt; uintptr_t &gt;&#160;</td>
          <td class="paramname"><em>stack</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="UContext_8h_source.html#l00039">39</a> of file <a class="el" href="UContext_8h_source.html">UContext.h</a>.</p>
<div class="fragment"><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;: <a class="code" href="structlibcommunism_1_1CothreadImpl.html#a061a94af18af48c50388163ea2e67553">CothreadImpl</a>(<a class="code" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>) {}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a9a0b99abcaf29d50c81932816263b0cb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9a0b99abcaf29d50c81932816263b0cb">&#9670;&nbsp;</a></span>~UContext()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">UContext::~UContext </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Deallocates a cothread. This releases the underlying stack if we allocated it. </p>

<p class="definition">Definition at line <a class="el" href="UContext_8cpp_source.html#l00081">81</a> of file <a class="el" href="UContext_8cpp_source.html">UContext.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                    {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordflow">if</span>(this-&gt;ownsStack) {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="preprocessor">#ifdef _WIN32</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        _aligned_free(this-&gt;<a class="code" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>.data());</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        free(this-&gt;<a class="code" href="structlibcommunism_1_1CothreadImpl.html#ab0bba692ebd47d478d4d7432ae738476">stack</a>.data());</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="ac77c7640686437e42884919732ca58d1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac77c7640686437e42884919732ca58d1">&#9670;&nbsp;</a></span>switchTo()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void UContext::switchTo </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structlibcommunism_1_1CothreadImpl.html">CothreadImpl</a> *&#160;</td>
          <td class="paramname"><em>from</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">override</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Performs a context switch to the provided cothread.</p>
<p>The state of the caller is stored on the stack of the currently active thread. </p>

<p>Implements <a class="el" href="structlibcommunism_1_1CothreadImpl.html#a6c8f840b8320dcf2c4257fac57694fd1">libcommunism::CothreadImpl</a>.</p>

<p class="definition">Definition at line <a class="el" href="UContext_8cpp_source.html#l00180">180</a> of file <a class="el" href="UContext_8cpp_source.html">UContext.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                                          {</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    swapcontext(UContext::ContextFor(from), UContext::ContextFor(<span class="keyword">this</span>));</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Friends And Related Function Documentation</h2>
<a id="a67705ee68a94373367dd49b99b3dbf18"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a67705ee68a94373367dd49b99b3dbf18">&#9670;&nbsp;</a></span>libcommunism::AllocKernelThreadWrapper</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structlibcommunism_1_1CothreadImpl.html">CothreadImpl</a>* <a class="el" href="namespacelibcommunism.html#a0ff8f089d6c4a8ef43dabcaceefb5b74">libcommunism::AllocKernelThreadWrapper</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">friend</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="afe3bd6961f54c575400fdad9fd858f16"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe3bd6961f54c575400fdad9fd858f16">&#9670;&nbsp;</a></span>kDefaultStackSize</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">constexpr const size_t libcommunism::internal::UContext::kDefaultStackSize {sizeof(uintptr_t) * 0x10000}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Default stack size in bytes, if none was requested by the caller. Since this implementation may work on different width architectures, we define this as 64K worth of machine words. </p>

<p class="definition">Definition at line <a class="el" href="UContext_8h_source.html#l00100">100</a> of file <a class="el" href="UContext_8h_source.html">UContext.h</a>.</p>

</div>
</div>
<a id="affcb29eed86604c5fcbbf229af2d54c9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#affcb29eed86604c5fcbbf229af2d54c9">&#9670;&nbsp;</a></span>kMainStackSize</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">constexpr const size_t libcommunism::internal::UContext::kMainStackSize {128}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Size of the stack buffer for the "fake" initial cothread, in machine words. This only needs to be large enough to fit the register stack frame. This <em>must</em> be a power of two.</p>
<p>It must be sufficiently large to fit an ucontext_t in it. </p>

<p class="definition">Definition at line <a class="el" href="UContext_8h_source.html#l00094">94</a> of file <a class="el" href="UContext_8h_source.html">UContext.h</a>.</p>

</div>
</div>
<a id="a5b5fb08c7e8b373ea1504ff4af4a1c53"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5b5fb08c7e8b373ea1504ff4af4a1c53">&#9670;&nbsp;</a></span>kStackAlignment</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">constexpr const size_t libcommunism::internal::UContext::kStackAlignment {64}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">constexpr</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Requested alignment for stack allocations.</p>
<p>64 bytes is the most stringent alignment requirements we should probably encounter in the real world (one cache line on most systems) and alignment doesn't result in <em>that</em> much overhead so this is fine.</p>
<dl class="section remark"><dt>Remarks</dt><dd>This must be a power of 2. </dd></dl>

<p class="definition">Definition at line <a class="el" href="UContext_8h_source.html#l00086">86</a> of file <a class="el" href="UContext_8h_source.html">UContext.h</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>src/arch/ucontext/<a class="el" href="UContext_8h_source.html">UContext.h</a></li>
<li>src/arch/ucontext/<a class="el" href="UContext_8cpp_source.html">UContext.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
